<!doctype html>
<html>
<head>
  <title>de Rham fractal explorer</title>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name='keywords' content='fractal, de Rham, curve, Koch snowflake, Blancmange curve, Lévy C-curve, Peano space-filling curve'>
  <meta name='description' content='Generate beautiful renderings of de Rham fractals.'>
  <link rel='icon' type='image/x-icon' href='data:image/x-icon;base64,'>
  <style>
html, body { height: 100%; background: black; color: white }
body { margin: 0; overflow: hidden }
form { position: absolute }
.hide { display: none !important }
#params > div { display: inline }
input[type=number] { width: 3rem }
  </style>
</head>
<body>
  <form>
    <div>
      <label for='presets'>Presets</label>
      <select id='presets'>
        <option value='none'>none</option>
        <option value='levyc'>Lévy C-curve</option>
        <option value='takagi'>Blancmange (Takagi)</option>
        <option value='snowflake'>Koch snowflake</option>
        <option value='peano'>Peano space-filling</option>
        <option value='v1'>Vepstas gallery #1</option>
        <option value='v2'>Vepstas gallery #2</option>
        <option value='v3'>Vepstas gallery #3</option>
        <option value='v4'>Vepstas gallery #4</option>
        <option value='v5'>Vepstas gallery #5</option>
        <option value='v6'>Vepstas gallery #6</option>
        <option value='v7'>Vepstas gallery #7</option>
        <option value='v8'>Vepstas gallery #8</option>
        <option value='v9'>Vepstas gallery #9</option>
        <option value='v10'>Vepstas gallery #10</option>
        <option value='v11'>Vepstas gallery #11</option>
        <option value='v12'>Vepstas gallery #12</option>
        <option value='v13'>Vepstas gallery #13</option>
        <option value='v14'>Vepstas gallery #14</option>
        <option value='v15'>Vepstas gallery #15</option>
        <option value='v16'>Vepstas gallery #16</option>
        <option value='v17'>Vepstas gallery #17</option>
        <option value='v18'>Vepstas gallery #18</option>
        <option value='v19'>Vepstas gallery #19</option>
        <option value='v20'>Vepstas gallery #20</option>
        <option value='v21'>Vepstas gallery #21</option>
        <option value='v22'>Vepstas gallery #22</option>
        <option value='v23'>Vepstas gallery #23</option>
        <option value='v24'>Vepstas gallery #24</option>
        <option value='v25'>Vepstas gallery #25</option>
        <option value='v26'>Vepstas gallery #26</option>
        <option value='v27'>Vepstas gallery #27</option>
        <option value='v28'>Vepstas gallery #28</option>
        <option value='v29'>Vepstas gallery #29</option>
        <option value='v30'>Vepstas gallery #30</option>
        <option value='v31'>Vepstas gallery #31</option>
        <option value='v32'>Vepstas gallery #32</option>
        <option value='v33'>Vepstas gallery #33</option>
        <option value='v34'>Vepstas gallery #34</option>
        <option value='v35'>Vepstas gallery #35</option>
        <option value='v36'>Vepstas gallery #36</option>
        <option value='v37'>Vepstas gallery #37</option>
        <option value='v38'>Vepstas gallery #38</option>
        <option value='v39'>Vepstas gallery #39</option>
        <option value='v40'>Vepstas gallery #40</option>
        <option value='v41'>Vepstas gallery #41</option>
      </select>
    </div>
    <div>
      <label for='fam'>Fractal families</label>
      <select id='fam'>
        <option value='cesaro'>Cesàro</option>
        <option value='koch'>Koch-Peano</option>
        <option value='derham'>de Rham</option>
      </select>
    </div>
    <div id='params'>
      <div><label for='a'>&alpha;</label> <input id='a' type='number' step='.01'></div>
      <div><label for='b'>&beta;</label> <input id='b' type='number' step='.01'></div>
      <div><label for='c'>&gamma;</label> <input id='c' type='number' step='.01'></div>
      <div><label for='d'>&delta;</label> <input id='d' type='number' step='.01'></div>
      <div><label for='e'>&epsilon;</label> <input id='e' type='number' step='.01'></div>
      <div><label for='f'>&zeta;</label> <input id='f' type='number' step='.01'></div>
    </div>
    <div><button>One more pass</button></div>
  </form>
  <canvas></canvas>
  <script src='machine.js'></script>
  <script>

// Page state
var app = new $.Machine({
  params: [.6, .45, .45, -.6, -.45, -.4],
  presets: {
    levyc: [.5, .5, -.5, .5, .5, .5],
    takagi: [.5, 1, 0, .6, 0, .6],
    snowflake: [.5, .28, .28, -.5, -.28, -.5],
    peano: [.5, .5, .5, -.5, -.5, -.5],
    v1: [.5, 1, .25, -.47, -.25, -.47],
    v2: [.5, 1, .25, -.25, -.25, -.25],
    v3: [.5, 1, .25, 0, -.25, 0],
    v4: [.5, 1, .18, -.38, -.18, -.42],
    v5: [.5, 1, .49, -.38, .1, -.42],
    v6: [.5, 1, .33, -.38, -.18, -.42],
    v7: [.5, 1, .18, -.28, -.18, -.72],
    v8: [.5, 1, .41, -.28, 0, -.58],
    v9: [.5, 1, .41, -.06, 0, -.58],
    v10: [.5, 1, .41, .1, 0, -.58],
    v11: [.5, 1, .51, .1, 0, -.58],
    v12: [.5, 1, .51, .1, -.2, -.58],
    v13: [.5, 1, .1, .15, .35, .88],
    v14: [.5, 1, -.05, .15, .35, .88],
    v15: [.5, 1, 0, .6, .3, .6],
    v16: [.5, 1, 0, .6, .18, .6],
    v17: [.5, 1, 0, -.7, 0, -.7],
    v18: [.5, 1, -.1, -.4, -.1, -.8],
    v19: [.5, 1, 0, -.7, -.15, .8],
    v20: [.5, 1, .3, -.7, -.15, .8],
    v21: [.5, 1, .3, -.7, -.15, 0],
    v22: [.5, 1, .3, -.7, -.15, -.3],
    v23: [.5, 1, -.1, -.7, -.15, -.3],
    v24: [.5, 1, -.1, -.8, -.3, -.6],
    v25: [.5, 1, -.1, -.8, -.3, -.8],
    v26: [.5, 1, -.1, -.4, -.3, -.8],
    v27: [.5, 1, 0, -.6, 0, -.6],
    v28: [.5, 1, -.35, .1, .3, -.4],
    v29: [.5, 1, -.45, .5, .35, -.45],
    v30: [.5, 1, -.45, .6, .5, -.45],
    v31: [.5, 1, -.3, .6, .6, -.2],
    v32: [.5, 1, .3, .15, .75, .18],
    v33: [.5, 1, .3, .15, .75, -.48],
    v34: [.5, 1, -.35, .6, .16, .6],
    v35: [.5, 1, -.2, .4, .4, 0],
    v36: [.5, 1, -.15, .15, .15, .85],
    v37: [.5, 1, -.4, .4, .4, .4],
    v38: [.5, 1, -.3, -.4, .2, .6],
    v39: [.5, 1, -.35, 0, .35, 0],
    v40: [.5, 1, -.35, 0, -.35, 0],
    v41: [.5, 1, -.5, 0, .5, 0]
  },
  maxlvl: null,
  cvs: $('canvas')[0],
  ctx: $('canvas')[0].getContext('2d'),
  fps: 15,
  initialPasses: 16,
  rendering: true,
  updating: false,
  scaleFac: 1,
  transOrg: null,
  tIndex: null,
  prevImg: null,
  renderMat: null,
  oneMore: null,
  workers: [],
  workerLoop:
`let multMat = (A, B) => Array(A.length).fill(0).map(row =>
      Array(B[0].length).fill(0)).map((row, i) => row.map((_, j) =>
        A[i].reduce((sum, el, k) => sum + (el * B[k][j]), 0))),
    d0 = (a, b, c, d) => (u, v) =>
      multMat([[0, a, c], [0, b, d]], [[1], [u], [v]]).flat(),
    d1 = (a, b, e, f) => (u, v) =>
      multMat([[a, 1 - a, e], [b, -b, f]], [[1], [u], [v]]).flat(),
    params, fn0, fn1, timing, prev = Infinity, tick, fps,
    deRham = i => {
      let res, next = [Math.random(), Math.random()];
      for (let p = 0; p <= maxlvl; p++) {
        res = next;
        next = i % 2 ? fn0(...res) : fn1(...res);
        i = i >> 1;
      }
      return res;
    },
    max, maxlvl, renderMat, step, n, updating = false, batch = [],
    loopAlongCurve = (step, n) => Promise.resolve().then(() => {
      if (n > max || updating) {
        postMessage({ done: true, batch });
        close()
      } else {
        let [a, b] = deRham(n);
        batch.push(multMat(renderMat, [[1], [a], [b]]).flat())
      }
      if ((tick = (performance.now() - timing) % (1000 / fps)) < prev) {
        prev = tick;
        postMessage({ batch });
        batch = [];
        return new Promise(r => setTimeout(r, 0))
      } else prev = tick;
    }).then(() => loopAlongCurve(step, n + 2 * step));
onmessage = e => {
  ({ fps, step, n, params, maxlvl, renderMat, updating } =
    Object.assign({ fps, step, n, params, maxlvl, renderMat, updating }, e.data));
  if ('maxlvl' in e.data) max = 1 << maxlvl;
  else if ('step' in e.data) {
    timing = performance.now();
    let [a, b, c, d, e, f] = params;
    fn1 = d0(a, b, c, d);
    fn0 = d1(a, b, e, f);
    loopAlongCurve(step, n)
  }
}`
});

function multMat (A, B) {
  return Array(A.length).fill(0).map(row => Array(B[0].length).fill(0))
    .map((row, i) => row.map((_, j) => A[i].reduce((sum, el, k) => sum + (el * B[k][j]), 0)))
}

// Events
$.targets({
  load () { app.emit('init') },
  wheel (e) { app.emit('scale', e) },
  app: {
    init () {
      $('#presets')[0].value = 'none';
      let select = $('#fam')[0];
      select.value = 'koch';
      $('#params input').forEach((el, i) => el.value = this.params[i])
      this.cvs.width = document.body.clientWidth;
      this.cvs.height = document.body.clientHeight;
      this.renderMat = [
        [this.cvs.width / 2 - this.cvs.height / 4, this.cvs.height / 2, 0],
        [3 * this.cvs.height / 4, 0, -this.cvs.height / 2]
      ];
      select.dispatchEvent(new Event('change'));
    },

    update () {
      this.params = $('#params input').map(el => el.valueAsNumber);
      this.updating = true;
      this.workers.map(w => w.postMessage({ updating: true }));
      new Promise(r => setTimeout(r, 1000/this.fps)).then(() =>
        app.emit('run', $('#fam')[0].value)) //
    },

    startUpdating () {
      if (!this.updating) {
        this.prevImg = document.createElement('canvas');
        this.prevImg.setAttribute('width', this.cvs.width);
        this.prevImg.setAttribute('height', this.cvs.height);
        this.prevImg.getContext('2d').drawImage(this.cvs, 0, 0)
      }
      this.updating = true;
      this.workers.map(w => w.postMessage({ updating: true }));
    },
    endUpdating () {
      this.updating = false;
      this.prevImg = null;
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      app.emit('run', $('#fam')[0].value)
    },

    scale (e) {
      let xorg = this.cvs.width / 2, yorg = this.cvs.height / 2;
      app.emit('startUpdating');
      this.scaleFac *= 1 + e.deltaY / 100;
      clearTimeout(this.tIndex);
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      this.ctx.drawImage(this.prevImg,
        (1 - this.scaleFac) * xorg, (1 - this.scaleFac) * yorg,
        this.scaleFac * this.cvs.width, this.scaleFac * this.cvs.height);
      new Promise(r => this.tIndex = setTimeout(r, 1000)).then(() => {
        this.renderMat = multMat(
          [[1, 0, 0], [-xorg, 1, 0], [-yorg, 0, 1]],
          [[1, 0, 0]].concat(this.renderMat));
        this.renderMat = multMat(
          [[1, 0, 0], [0, this.scaleFac, 0], [0, 0, this.scaleFac]],
          this.renderMat);
        this.renderMat = multMat(
          [[1, 0, 0], [xorg, 1, 0], [yorg, 0, 1]],
          this.renderMat).slice(1);
        this.scaleFac = 1;
        app.emit('endUpdating')
      })
    },

    startTranslate (e) {
      app.emit('startUpdating');
      this.transOrg = { x: e.layerX, y: e.layerY };
      $.queries({ canvas: {
        pointermove (e) { app.emit('translate', e) },
        pointerup (e) { app.emit('endTranslate', e) }
      } })
    },
    translate (e) {
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      this.ctx.drawImage(this.prevImg,
        e.layerX - this.transOrg.x,
        e.layerY - this.transOrg.y)
    },
    endTranslate (e) {
      this.renderMat = multMat(
        [[1, 0, 0], [e.layerX - this.transOrg.x, 1, 0], [e.layerY - this.transOrg.y, 0, 1]],
        [[1, 0, 0]].concat(this.renderMat)).slice(1);
      this.transOrg = null;
      $.queries({ canvas: { pointermove: 'pointermove', pointerup: 'pointerup' } });
      app.emit('endUpdating');
    },

    run (type) {
      $('button')[0].disabled = true;
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      let [a, b, c, d, e, f] = this.params, count = 0;
      switch (type) {
        case 'cesaro': this.params = [a, b, c = -b, d = a, e = b, f = 1 - a]; break
        case 'koch': this.params = [a, b, c = b, d = -a, e = -b, f = a - 1]
      }
      this.rendering = true;
      this.updating = false;
      this.maxlvl = this.initialPasses;
      this.ctx.fillStyle = 'red';
      let lvl = 0,
          tau = Math.PI * 2,
          loopDepthPass = () => Promise.resolve().then(() => {
            this.workers.forEach(w => w.terminate());
            this.workers = [];
            if (++lvl > this.maxlvl) return new Promise(r => {
              $('button')[0].disabled = false;
              this.rendering = false;
              this.oneMore = r
            }).then(() => {
              $('button')[0].disabled = true;
              this.rendering = true;
              this.oneMore = null;
              ++this.maxlvl
            });
          }).then(() => {
              let step = 1 << (this.maxlvl - lvl),
                  threads = navigator.hardwareConcurrency - 1 || 1,
                  workers = Array(threads).fill(0)
                    .map(() => {
                      let w = new Worker(URL.createObjectURL(new Blob(
                        [this.workerLoop], { type: 'application/javascript' })));
                      this.workers.push(w);
                      w.postMessage({
                        fps: this.fps, maxlvl: this.maxlvl,
                        renderMat: this.renderMat, params: [a, b, c, d, e, f] });
                      return i => new Promise(r => {
                        w.onmessage = e => {
                          for (let coords of e.data.batch) {
                            this.ctx.beginPath();
                            this.ctx.arc(...coords, .25, 0, tau, true);
                            this.ctx.fill();
                          }
                          if (e.data.done) r();
                        };
                        w.postMessage({ step: step * threads, n: 2 * step * (i + 1) });
                      })
                    });
              return Promise.all(workers.map((w, i) => w(i)))
            })
            .then(loopDepthPass)
      return loopDepthPass()
    }
  }
});

$.queries({
  canvas: { pointerdown (e) { app.emit('startTranslate', e) } },
  '#fam': { change (e) {
    if (this.value === 'derham') $('#params > div').forEach(el => el.classList.remove('hide'));
    else $('#params > div:nth-child(n+3)').forEach(el => el.classList.add('hide'));
    app.emit('update')
  } },
  '#presets': { change (e) {
    switch (this.value) {
      case 'none': return;
      case 'levyc': $('#fam')[0].value = 'cesaro'; break;
      case 'snowflake': case 'peano': $('#fam')[0].value = 'koch'; break;
      default: $('#fam')[0].value = 'derham'
    }
    $('input[type=number]').forEach((el, i) => el.value = app.state().presets[this.value][i]);
    $('#fam')[0].dispatchEvent(new Event('change'))
  } },
  'input[type=number]': { change (e) {
    $('#presets')[0].value = 'none';
    app.emit('update')
  } },
  button: { click (e) {
    e.preventDefault();
    app.state().oneMore()
  } }
})

  </script>
  <noscript><h6>Only viewable with JavaScript enabled.</h6></noscript>
</body>
</html>
