<!doctype html>
<html>
<head>
  <title>de Rham fractal explorer</title>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=0'>
  <meta name='keywords' content='fractal, de Rham, curve, Koch snowflake, Blancmange curve, Lévy C-curve, Peano space-filling curve'>
  <meta name='description' content='Generate beautiful renderings of de Rham fractals.'>
  <link rel='icon' type='image/x-icon' href='data:image/x-icon;base64,'>
  <style>
html, body { height: 100%; background: black; color: white }
body { margin: 0; overflow: hidden }
form { position: absolute }
.hide { display: none !important }
#params > div { display: inline }
input[type=number] { width: 3rem }
  </style>
</head>
<body>
  <form>
    <div>
      <label for='presets'>Presets</label>
      <select id='presets'>
        <option value='none'>none</option>
        <option value='levyc' data-params='.5, .5, -.5, .5, .5, .5'>Lévy C-curve</option>
        <option value='takagi' data-params='.5, 1, 0, .6, 0, .6'>Blancmange (Takagi)</option>
        <option value='snowflake' data-params='.5, .28, .28, -.5, -.28, -.5'>Koch snowflake</option>
        <option value='peano' data-params='.5, .5, .5, -.5, -.5, -.5'>Peano space-filling</option>
        <option value='v1' data-params='.5, 1, .25, -.47, -.25, -.47'>Vepstas gallery #1</option>
        <option value='v2' data-params='.5, 1, .25, -.25, -.25, -.25'>Vepstas gallery #2</option>
        <option value='v3' data-params='.5, 1, .25, 0, -.25, 0'>Vepstas gallery #3</option>
        <option value='v4' data-params='.5, 1, .18, -.38, -.18, -.42'>Vepstas gallery #4</option>
        <option value='v5' data-params='.5, 1, .49, -.38, .1, -.42'>Vepstas gallery #5</option>
        <option value='v6' data-params='.5, 1, .33, -.38, -.18, -.42'>Vepstas gallery #6</option>
        <option value='v7' data-params='.5, 1, .18, -.28, -.18, -.72'>Vepstas gallery #7</option>
        <option value='v8' data-params='.5, 1, .41, -.28, 0, -.58'>Vepstas gallery #8</option>
        <option value='v9' data-params='.5, 1, .41, -.06, 0, -.58'>Vepstas gallery #9</option>
        <option value='v10' data-params='.5, 1, .41, .1, 0, -.58'>Vepstas gallery #10</option>
        <option value='v11' data-params='.5, 1, .51, .1, 0, -.58'>Vepstas gallery #11</option>
        <option value='v12' data-params='.5, 1, .51, .1, -.2, -.58'>Vepstas gallery #12</option>
        <option value='v13' data-params='.5, 1, .1, .15, .35, .88'>Vepstas gallery #13</option>
        <option value='v14' data-params='.5, 1, -.05, .15, .35, .88'>Vepstas gallery #14</option>
        <option value='v15' data-params='.5, 1, 0, .6, .3, .6'>Vepstas gallery #15</option>
        <option value='v16' data-params='.5, 1, 0, .6, .18, .6'>Vepstas gallery #16</option>
        <option value='v17' data-params='.5, 1, 0, -.7, 0, -.7'>Vepstas gallery #17</option>
        <option value='v18' data-params='.5, 1, -.1, -.4, -.1, -.8'>Vepstas gallery #18</option>
        <option value='v19' data-params='.5, 1, 0, -.7, -.15, .8'>Vepstas gallery #19</option>
        <option value='v20' data-params='.5, 1, .3, -.7, -.15, .8'>Vepstas gallery #20</option>
        <option value='v21' data-params='.5, 1, .3, -.7, -.15, 0'>Vepstas gallery #21</option>
        <option value='v22' data-params='.5, 1, .3, -.7, -.15, -.3'>Vepstas gallery #22</option>
        <option value='v23' data-params='.5, 1, -.1, -.7, -.15, -.3'>Vepstas gallery #23</option>
        <option value='v24' data-params='.5, 1, -.1, -.8, -.3, -.6'>Vepstas gallery #24</option>
        <option value='v25' data-params='.5, 1, -.1, -.8, -.3, -.8'>Vepstas gallery #25</option>
        <option value='v26' data-params='.5, 1, -.1, -.4, -.3, -.8'>Vepstas gallery #26</option>
        <option value='v27' data-params='.5, 1, 0, -.6, 0, -.6'>Vepstas gallery #27</option>
        <option value='v28' data-params='.5, 1, -.35, .1, .3, -.4'>Vepstas gallery #28</option>
        <option value='v29' data-params='.5, 1, -.45, .5, .35, -.45'>Vepstas gallery #29</option>
        <option value='v30' data-params='.5, 1, -.45, .6, .5, -.45'>Vepstas gallery #30</option>
        <option value='v31' data-params='.5, 1, -.3, .6, .6, -.2'>Vepstas gallery #31</option>
        <option value='v32' data-params='.5, 1, .3, .15, .75, .18'>Vepstas gallery #32</option>
        <option value='v33' data-params='.5, 1, .3, .15, .75, -.48'>Vepstas gallery #33</option>
        <option value='v34' data-params='.5, 1, -.35, .6, .16, .6'>Vepstas gallery #34</option>
        <option value='v35' data-params='.5, 1, -.2, .4, .4, 0'>Vepstas gallery #35</option>
        <option value='v36' data-params='.5, 1, -.15, .15, .15, .85'>Vepstas gallery #36</option>
        <option value='v37' data-params='.5, 1, -.4, .4, .4, .4'>Vepstas gallery #37</option>
        <option value='v38' data-params='.5, 1, -.3, -.4, .2, .6'>Vepstas gallery #38</option>
        <option value='v39' data-params='.5, 1, -.35, 0, .35, 0'>Vepstas gallery #39</option>
        <option value='v40' data-params='.5, 1, -.35, 0, -.35, 0'>Vepstas gallery #40</option>
        <option value='v41' data-params='.5, 1, -.5, 0, .5, 0'>Vepstas gallery #41</option>
      </select>
    </div>
    <div>
      <label for='fam'>Fractal families</label>
      <select id='fam'>
        <option value='cesaro'>Cesàro</option>
        <option value='koch'>Koch-Peano</option>
        <option value='derham'>de Rham</option>
      </select>
    </div>
    <div id='params'>
      <div><label for='a'>&alpha;</label> <input id='a' type='number' step='.01'></div>
      <div><label for='b'>&beta;</label> <input id='b' type='number' step='.01'></div>
      <div><label for='c'>&gamma;</label> <input id='c' type='number' step='.01'></div>
      <div><label for='d'>&delta;</label> <input id='d' type='number' step='.01'></div>
      <div><label for='e'>&epsilon;</label> <input id='e' type='number' step='.01'></div>
      <div><label for='f'>&zeta;</label> <input id='f' type='number' step='.01'></div>
    </div>
    <div><button>One more pass</button></div>
  </form>
  <canvas></canvas>
  <script src='machine.js'></script>
  <script>

// Page state
var app = new $.Machine({
  params: [.6, .45, .45, -.6, -.45, -.4],
  cvs: $('canvas')[0],
  ctx: $('canvas')[0].getContext('2d'),
  fps: 15,
  initialPasses: 16,
  updating: false,
  transOrg: null,
  scaleUnit: 1,
  tIndex: null,
  prevImg: null,
  renderMat: null,
  oneMore: null,
  workers: []
});

function multMat (A, B) {
  return Array(A.length).fill(0).map(row => Array(B[0].length).fill(0))
    .map((row, i) => row.map((_, j) => A[i].reduce((sum, el, k) => sum + (el * B[k][j]), 0)))
}
function translate (M, x, y) {
  return multMat([[1, 0, 0], [x, 1, 0], [y, 0, 1]], [[1, 0, 0]].concat(M)).slice(1)
}
function scale (M, u) {
  return multMat([[1, 0, 0], [0, u, 0], [0, 0, u]], [[1, 0, 0]].concat(M)).slice(1)
}

// Events
$.targets({
  load () { app.emit('init') },
  wheel (e) { app.emit('scrollScale', e) },
  resize () { app.emit('resize', false) },
  app: {
    init () {
      if (navigator.maxTouchPoints > 1)
        $.queries({ canvas: { touchstart (e) { app.emit('startTransform', e) } } });
      else $.queries({ canvas: { pointerdown (e) { app.emit('startTranslate', e) } } });
      $('#presets')[0].value = 'none';
      let select = $('#fam')[0];
      select.value = 'koch';
      $('#params input').forEach((el, i) => el.value = this.params[i]);
      this.cvs.width = document.body.clientWidth;
      this.cvs.height = document.body.clientHeight;
      this.renderMat = [
        [this.cvs.width / 2 - this.cvs.height / 4, this.cvs.height / 2, 0],
        [3 * this.cvs.height / 4, 0, -this.cvs.height / 2]
      ];
      app.emit('resize', true);
      select.dispatchEvent(new Event('change'));
    },

    resize (init) {
      if (init) {
        this.updating = true;
        this.workers.map(w => w.postMessage({ updating: true }));
      }
      let width = document.body.clientWidth, height = document.body.clientHeight;
      this.renderMat = translate(this.renderMat,
        (width - this.cvs.width) / 2, (height - this.cvs.height) / 2);
      this.cvs.width = width;
      this.cvs.height = height;
      new Promise(r => setTimeout(r, 1000 / this.fps)).then(() => app.emit('run'))
    },

    update () {
      this.params = $('#params input').map(el => el.valueAsNumber);
      this.updating = true;
      this.workers.map(w => w.postMessage({ updating: true }));
      new Promise(r => setTimeout(r, 1000 / this.fps)).then(() => app.emit('run'))
    },

    startUpdating () {
      if (!this.updating) {
        this.prevImg = document.createElement('canvas');
        this.prevImg.setAttribute('width', this.cvs.width);
        this.prevImg.setAttribute('height', this.cvs.height);
        this.prevImg.getContext('2d').drawImage(this.cvs, 0, 0)
      }
      this.updating = true;
      this.workers.map(w => w.postMessage({ updating: true }));
    },
    endUpdating () {
      this.updating = false;
      this.prevImg = null;
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      app.emit('run')
    },

    scrollScale (e) {
      let xorg = this.cvs.width / 2, yorg = this.cvs.height / 2;
      app.emit('startUpdating');
      this.scaleUnit *= 1 + e.deltaY / 100;
      clearTimeout(this.tIndex);
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      this.ctx.drawImage(this.prevImg,
        (1 - this.scaleUnit) * xorg, (1 - this.scaleUnit) * yorg,
        this.scaleUnit * this.cvs.width, this.scaleUnit * this.cvs.height);
      new Promise(r => this.tIndex = setTimeout(r, 1000)).then(() => {
        this.renderMat = translate(this.renderMat, -xorg, -yorg);
        this.renderMat = scale(this.renderMat, this.scaleUnit);
        this.renderMat = translate(this.renderMat, xorg, yorg);
        this.scaleUnit = 1;
        app.emit('endUpdating')
      })
    },

    startTranslate (e) {
      app.emit('startUpdating');
      this.transOrg = { x: e.clientX, y: e.clientY };
      $.queries({ canvas: {
        pointermove (e) { app.emit('translate', e) },
        pointerup (e) { app.emit('endTranslate', e) }
      } })
    },
    translate (e) {
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      this.ctx.drawImage(this.prevImg,
        e.clientX - this.transOrg.x, e.clientY - this.transOrg.y)
    },
    endTranslate (e) {
      this.renderMat = translate(this.renderMat,
        e.clientX - this.transOrg.x, e.clientY - this.transOrg.y);
      this.transOrg = null;
      $.queries({ canvas: { pointermove: 'pointermove', pointerup: 'pointerup' } });
      app.emit('endUpdating');
    },

    startTransform (e) {
      app.emit('startUpdating');
      let ts = e.touches;
      if (ts.length === 1) this.transOrg = { x: ts[0].clientX, y: ts[0].clientY };
      else if (ts.length > 1) {
        this.transOrg = { x: (ts[0].clientX + ts[1].clientX) / 2,
          y: (ts[0].clientY + ts[1].clientY) / 2 };
        this.scaleUnit = { u: Math.hypot(ts[0].clientX - ts[1].clientX, ts[0].clientY - ts[1].clientY) };
      }
      $.queries({ canvas: {
        touchmove (e) { app.emit('transform', e) },
        touchend (e) { app.emit('endTransform', e) }
      } })
    },
    transform (e) {
      let ts = e.touches;
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      if (this.scaleUnit) {
        this.transOrg.x1 = (ts[0].clientX + ts[1].clientX) / 2;
        this.transOrg.y1 = (ts[0].clientY + ts[1].clientY) / 2;
        this.scaleUnit.u1 = Math.hypot(ts[0].clientX - ts[1].clientX, ts[0].clientY - ts[1].clientY);
        let fact = this.scaleUnit.u1 / this.scaleUnit.u;
        this.ctx.drawImage(this.prevImg,
          this.transOrg.x1 - this.transOrg.x + (1 - fact) * this.cvs.width / 2,
          this.transOrg.y1 - this.transOrg.y + (1 - fact) * this.cvs.height / 2,
          this.cvs.width * fact, this.cvs.height * fact)
      } else this.ctx.drawImage(this.prevImg, (this.transOrg.x1 = ts[0].clientX) - this.transOrg.x,
        (this.transOrg.y1 = ts[0].clientY) - this.transOrg.y)
    },
    endTransform (e) {
      if (this.scaleUnit) {
        let xorg = this.cvs.width / 2, yorg = this.cvs.height / 2;
        this.renderMat = translate(this.renderMat, -xorg, -yorg);
        this.renderMat = scale(this.renderMat, this.scaleUnit.u1 / this.scaleUnit.u);
        this.renderMat = translate(this.renderMat,
          xorg + this.transOrg.x1 - this.transOrg.x, yorg + this.transOrg.y1 - this.transOrg.y);
        this.scaleUnit = 1;
      } else this.renderMat = translate(this.renderMat,
        this.transOrg.x1 - this.transOrg.x, this.transOrg.y1 - this.transOrg.y);
      this.transOrg = null;
      $.queries({ canvas: { touchmove: 'touchmove', touchend: 'touchend' } });
      app.emit('endUpdating');
    },

    run () {
      let [a, b, c, d, e, f] = this.params, count = 0, maxlvl = this.initialPasses,
          workerLoop = `
            let multMat = (A, B) => Array(A.length).fill(0).map(row =>
                  Array(B[0].length).fill(0)).map((row, i) => row.map((_, j) =>
                    A[i].reduce((sum, el, k) => sum + (el * B[k][j]), 0))),
                d0 = (a, b, c, d) => (u, v) =>
                  multMat([[0, a, c], [0, b, d]], [[1], [u], [v]]).flat(),
                d1 = (a, b, e, f) => (u, v) =>
                  multMat([[a, 1 - a, e], [b, -b, f]], [[1], [u], [v]]).flat(),
                params, fn0, fn1, timing, prev = Infinity, tick, fps,
                max, maxlvl, renderMat, step, n, updating = false, batch = [],
                deRham = i => {
                  let res, next = [Math.random(), Math.random()];
                  for (let p = 0; p <= maxlvl; p++) {
                    res = next;
                    next = i % 2 ? fn0(...res) : fn1(...res);
                    i >>= 1;
                  }
                  return res.map(v => [v]);
                },
                loopAlongCurve = (step, n) => Promise.resolve().then(() => {
                  if (n > max || updating) {
                    postMessage({ done: true, batch });
                    close()
                  } else batch.push(multMat(renderMat, [[1], ...deRham(n)]).flat());
                  if ((tick = (performance.now() - timing) % (1000 / fps)) < prev) {
                    prev = tick;
                    postMessage({ batch });
                    batch = [];
                    return new Promise(r => setTimeout(r, 0))
                  } else prev = tick;
                }).then(() => loopAlongCurve(step, n + 2 * step));
            onmessage = e => {
              ({ fps, step, n, params, maxlvl, renderMat, updating } =
                Object.assign({ fps, step, n, params, maxlvl, renderMat, updating }, e.data));
              if ('maxlvl' in e.data) max = 1 << maxlvl;
              else if ('step' in e.data) {
                timing = performance.now();
                let [a, b, c, d, e, f] = params;
                fn1 = d0(a, b, c, d);
                fn0 = d1(a, b, e, f);
                loopAlongCurve(step, n)
              }
            }`;
      $('button')[0].disabled = true;
      this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);
      switch ($('#fam')[0].value) {
        case 'cesaro': this.params = [a, b, c = -b, d = a, e = b, f = 1 - a]; break
        case 'koch': this.params = [a, b, c = b, d = -a, e = -b, f = a - 1]
      }
      this.updating = false;
      this.ctx.fillStyle = 'red';
      let lvl = 0, tau = Math.PI * 2,
          loopDepthPass = () => Promise.resolve().then(() => {
            this.workers.forEach(w => w.terminate());
            this.workers = [];
            if (++lvl > maxlvl) return new Promise(r => {
              $('button')[0].disabled = false;
              this.oneMore = r
            }).then(() => {
              $('button')[0].disabled = true;
              this.oneMore = null;
              ++maxlvl
            });
          }).then(() => {
              let step = 1 << (maxlvl - lvl),
                  threads = navigator.hardwareConcurrency - 1 || 1,
                  workers = Array(threads).fill(0)
                    .map(() => {
                      let w = new Worker(URL.createObjectURL(new Blob(
                        [workerLoop], { type: 'application/javascript' })));
                      this.workers.push(w);
                      w.postMessage({ fps: this.fps, maxlvl,
                        renderMat: this.renderMat, params: [a, b, c, d, e, f] });
                      return i => new Promise(r => {
                        w.onmessage = e => {
                          for (let coords of e.data.batch) {
                            this.ctx.beginPath();
                            this.ctx.arc(...coords, .25, 0, tau, true);
                            this.ctx.fill();
                          }
                          if (e.data.done) r();
                        };
                        w.postMessage({ step: step * threads, n: 2 * step * (i + 1) })
                      })
                    });
              return Promise.all(workers.map((w, i) => w(i)))
            })
            .then(loopDepthPass)
      return loopDepthPass()
    }
  }
});

$.queries({
  '#fam': { change (e) {
    if (this.value === 'derham') $('#params > div').forEach(el => el.classList.remove('hide'));
    else $('#params > div:nth-child(n+3)').forEach(el => el.classList.add('hide'));
    app.emit('update')
  } },
  '#presets': { change (e) {
    switch (this.value) {
      case 'none': return;
      case 'levyc': $('#fam')[0].value = 'cesaro'; break;
      case 'snowflake': case 'peano': $('#fam')[0].value = 'koch'; break;
      default: $('#fam')[0].value = 'derham'
    }
    let preset = $('#presets')[0].selectedOptions[0].dataset.params.split(', ').map(parseFloat);
    $('input[type=number]').forEach((el, i) => el.value = preset[i]);
    $('#fam')[0].dispatchEvent(new Event('change'))
  } },
  'input[type=number]': { change (e) {
    $('#presets')[0].value = 'none';
    app.emit('update')
  } },
  button: { click (e) {
    e.preventDefault();
    app.state().oneMore()
  } }
})

  </script>
  <noscript><h6>Only viewable with JavaScript enabled.</h6></noscript>
</body>
</html>
